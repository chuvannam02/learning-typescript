name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: DOCKERHUB_USERNAME

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4
        
      - name: üßæ Log checkout step
        run: echo "üßæ Checkout completed ‚úÖ"
        continue-on-error: false

      - name: üß∞ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: üß∞ Log Buildx setup
        run: echo "üß∞ Docker Buildx set up completed ‚úÖ"
        continue-on-error: false
        
      - name: üîë Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: üß∞ Log Login to Docker Hub
        run: echo "üß∞ Login into Docker Hub succeed ‚úÖ"
        continue-on-error: false

      - name: üïí Generate timestamp tag
        id: time
        run: |
          TAG=$(TZ="Asia/Bangkok" date +'%d-%m-%Y_%H-%M-%S')
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "üïì Generated tag (UTC+7): $TAG"

      - name: üèóÔ∏è Build and push Docker image
        id: build
        continue-on-error: true   # Cho ph√©p ti·∫øp t·ª•c ƒë·ªÉ ta log l·ªói th·ªß c√¥ng
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/learning-typescript:${{ env.TAG }}

      - name: üßπ Logout from Docker Hub
        if: always()
        run: docker logout

      - name: Clean up old images (keep last N) with detailed logs
        env:
          DOCKERHUB_USER: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          IMAGE_NAME: learning-typescript
          KEEP_COUNT: 10
        run: |
          set -o pipefail

          echo "üßπ Start cleanup old images for: $DOCKERHUB_USER/$IMAGE_NAME"
          echo "üßæ Keep newest $KEEP_COUNT tags (excluding 'latest')"

          # install tools
          sudo apt-get update -y
          sudo apt-get install -y jq curl

          # fetch all tags (handle pagination)
          PAGE=1
          PAGE_SIZE=100
          ALL_TAGS_JSON="[]"

          while :; do
            URL="https://hub.docker.com/v2/repositories/$DOCKERHUB_USER/$IMAGE_NAME/tags/?page_size=$PAGE_SIZE&page=$PAGE"
            echo "üîé Fetching tags page $PAGE..."
            RESP=$(curl -s -u "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" "$URL")
            if [ -z "$RESP" ]; then
              echo "‚ö†Ô∏è Empty response for page $PAGE ‚Äî aborting pagination"
              break
            fi

            # collect results
            PAGE_RESULTS=$(echo "$RESP" | jq '.results')
            ALL_TAGS_JSON=$(jq -s '.[0] + .[1]' <(echo "$ALL_TAGS_JSON") <(echo "$PAGE_RESULTS"))

            # check if has next page
            NEXT=$(echo "$RESP" | jq -r '.next')
            if [ "$NEXT" = "null" ] || [ -z "$NEXT" ]; then
              break
            fi
            PAGE=$((PAGE+1))
          done

          # transform to array of {name, last_updated}
          TAGS_SORTED=$(echo "$ALL_TAGS_JSON" | jq -c '[ .[] | {name: .name, last_updated: .last_updated} ] | sort_by(.last_updated) | reverse')

          TOTAL_TAGS=$(echo "$TAGS_SORTED" | jq 'length')
          echo "‚ÑπÔ∏è Total tags fetched: $TOTAL_TAGS"

          if [ "$TOTAL_TAGS" -eq 0 ]; then
            echo "‚ÑπÔ∏è No tags found, nothing to delete."
            exit 0
          fi

          # print first 20 tags for visibility (safeguard)
          echo "üßæ Top tags (newest first):"
          echo "$TAGS_SORTED" | jq -r '.[0:20] | .[] | " - \(.name) (updated: \(.last_updated))"'

          # build list to keep and to delete (skip 'latest')
          KEEP=$(echo "$TAGS_SORTED" | jq -r --argjson k "$KEEP_COUNT" '[ .[] | select(.name != "latest") ] | .[0:$k] | .[].name')
          DELETE=$(echo "$TAGS_SORTED" | jq -r --argjson k "$KEEP_COUNT" '[ .[] | select(.name != "latest") ] | .[$k:] | .[].name')

          echo "----------------------------------------"
          echo "Keeping tags:"
          if [ -z "$KEEP" ]; then
            echo " - (none)"
          else
            echo "$KEEP" | sed 's/^/ - /'
          fi

          echo "----------------------------------------"
          echo "Will delete tags (older than the first $KEEP_COUNT non-latest tags):"
          if [ -z "$DELETE" ]; then
            echo " - (none)"
          else
            echo "$DELETE" | sed 's/^/ - /'
          fi
          echo "----------------------------------------"

          # delete tags one by one, count successes/failures
          DELETED_COUNT=0
          FAILED_COUNT=0
          if [ -n "$DELETE" ]; then
            while read -r T; do
              if [ -z "$T" ]; then
                continue
              fi
              echo "üóëÔ∏è Deleting tag: $T ..."
              DEL_URL="https://hub.docker.com/v2/repositories/$DOCKERHUB_USER/$IMAGE_NAME/tags/$T/"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -u "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" -X DELETE "$DEL_URL")
              if [ "$HTTP_CODE" = "204" ]; then
                echo "   ‚úÖ Deleted: $T (HTTP $HTTP_CODE)"
                DELETED_COUNT=$((DELETED_COUNT+1))
              else
                echo "   ‚ùå Failed to delete $T (HTTP $HTTP_CODE)"
                FAILED_COUNT=$((FAILED_COUNT+1))
              fi
            done <<< "$DELETE"
          else
            echo "‚ÑπÔ∏è Nothing to delete."
          fi

          echo "----------------------------------------"
          echo "Summary:"
          echo " - Total tags fetched: $TOTAL_TAGS"
          echo " - Kept (non-latest, newest $KEEP_COUNT): $(echo \"$KEEP\" | wc -l | tr -d ' ')"
          echo " - Deleted: $DELETED_COUNT"
          echo " - Failures: $FAILED_COUNT"
          echo "----------------------------------------"

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "‚ö†Ô∏è Some deletions failed. Check the HTTP codes above for more information."
            # Do not fail the job by default; if you want to fail CI when delete fails, uncomment next line:
            # exit 1
          fi

          echo "‚úÖ Cleanup step finished."

      - name: ‚úÖ Log success
        if: steps.build.outcome == 'success'
        run: |
          echo ""
          echo "‚úÖ‚úÖ‚úÖ SUCCESS ‚úÖ‚úÖ‚úÖ"
          echo "Docker image pushed successfully!"
          echo "Image tags:"
          echo " - ${{ vars.DOCKERHUB_USERNAME }}/learning-typescript:${{ env.TAG }}"
          echo ""

      - name: ‚ùå Log failure
        if: steps.build.outcome != 'success'
        run: |
          echo ""
          echo "‚ùå‚ùå‚ùå FAILED ‚ùå‚ùå‚ùå"
          echo "Build or push failed. Please check logs above for details."
          exit 1
