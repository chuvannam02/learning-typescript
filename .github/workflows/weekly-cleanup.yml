name: Weekly Docker Hub Cleanup

on:
  # Thiết lập lịch chạy tự động
  schedule:
    # Cú pháp cron: phút giờ ngày_trong_tháng tháng ngày_trong_tuần
    # Cron này chạy vào lúc 9:00 sáng (UTC) Chủ Nhật hàng tuần.
    # 0 9 * * 0
    # 0: phút (phút 0)
    # 9: giờ (giờ 9)
    # *: ngày trong tháng (mọi ngày)
    # *: tháng (mọi tháng)
    # 0: ngày trong tuần (Chủ Nhật, 1 là Thứ Hai)
    - cron: '0 9 * * 0'
  
  # Thêm workflow_dispatch để có thể chạy thủ công (tùy chọn)
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    env:
      # Giữ nguyên các biến môi trường
      DOCKER_USERNAME: ${{ vars.DOCKERHUB_USERNAME }} 
      DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }} 
      REPOSITORY_NAME: ten-cua-repo-tren-docker-hub

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run Cleanup Script
        run: |
          # 1. Cài đặt thư viện 'requests'
          pip install requests
          
          # 2. Chạy script và truyền các biến môi trường vào dưới dạng đối số (arguments)
          python cleanup_script.py \
            --user $DOCKER_USERNAME \
            --password $DOCKER_PASSWORD \
            --repo $REPOSITORY_NAME \
            --keep-latest 5 # Số lượng tags mới nhất bạn muốn giữ lại

