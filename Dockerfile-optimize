# ---------- Stage 1: Build FE (alpine, non-root) ----------
FROM node:20-alpine AS builder

# cài 1 số tool nhỏ để nén (brotli, gzip là sẵn có)
RUN apk add --no-cache brotli bash

WORKDIR /app

# copy lock file trước để tận dụng cache
COPY package.json package-lock.json* ./

# install
RUN npm ci --silent

# copy source và build
COPY . .
RUN npm run build

# Pre-compress static assets for gzip + brotli
# - chỉ nén các file thường gặp: .js .css .html .svg .json .wasm
RUN find dist -type f \( -name '*.js' -o -name '*.css' -o -name '*.html' -o -name '*.svg' -o -name '*.json' -o -name '*.wasm' \) \
  -exec gzip -9 -k -f '{}' \; \
  -exec brotli -q 11 -f --no-warn '{}' \;

# ---------- Stage 2: Final runtime (nginx alpine slim) ----------
FROM nginx:1.29-alpine-slim

# tạo group/user non-root (nếu image chưa có)
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# remove default static
RUN rm -rf /usr/share/nginx/html/*

# Copy optimized nginx config
COPY nginx-optimize.conf /etc/nginx/conf.d/default.conf

# Copy build artifacts
COPY --from=builder /app/dist /usr/share/nginx/html

# Set ownership: nginx runs as nginx user in this image; ensure correctness
RUN chown -R nginx:nginx /usr/share/nginx/html

# Expose port (internal) - bạn có thể map ra 80 hoặc 8080 ở runtime
EXPOSE 8080

# Healthcheck (sử dụng wget nhỏ)
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s --retries=3 \
  CMD wget -qO- http://127.0.0.1:8080/ || exit 1

# Run as nginx user (nginx image will switch correctly on start)
CMD ["nginx", "-g", "daemon off;"]
