#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# 1. Switch Node version theo .nvmrc nếu có
if [ -f ".nvmrc" ]; then
  echo "Switching Node version to $(cat .nvmrc)"
  nvm use
fi

# 2. Lấy danh sách file staged JS/TS/TSX
STAGED_FILES=$(git diff --cached --name-only -- '*.ts' '*.js' '*.tsx' '*.jsx')

if [ -z "$STAGED_FILES" ]; then
  echo "No JS/TS files staged. Skipping pre-commit."
  exit 0
fi

echo "=== Pre-commit: Removing console.log statements ==="

# 3. Xoá console.log(...) và log file đã chỉnh sửa
for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    COUNT_BEFORE=$(grep -c 'console\.log(' "$file" || true)
    if [ "$COUNT_BEFORE" -gt 0 ]; then
      sed -i.bak '/console\.log(/d' "$file"
      rm -f "$file.bak"
      git add "$file"
      echo "[REMOVED] $COUNT_BEFORE console.log(s) from $file"
    else
      echo "[SKIPPED] No console.log in $file"
    fi
  fi
done

# 4. Chạy eslint chỉ trên staged files, bỏ qua unused vars
echo "=== Running ESLint on staged files (ignoring unused vars) ==="
npx eslint $STAGED_FILES --fix \
  --rule 'no-unused-vars: off' \
  --rule '@typescript-eslint/no-unused-vars: off'

# 5. Nếu eslint fail (ngoài unused vars), chặn commit
if [ $? -ne 0 ]; then
  echo "ESLint failed. Commit aborted."
  exit 1
fi

echo "✅ Pre-commit checks passed!"
